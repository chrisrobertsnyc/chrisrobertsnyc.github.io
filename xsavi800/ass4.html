<!DOCTYPE html>
<html>

<head>
<title>Assignment 4</title>
<style>
html, body {
	height: 100%;
	width: 100%;
}
#map {
	height: 100%;
	width: 100%;
}
</style>
<!--Load Leaflet-->
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<!--Load TURF-->
<script src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
<!--Load JQuery-->
<script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
</head>

<body>
<div id="map"></div>
<script>
//Map functionality:
	//click on a neighborhood
	//retrieve neighborhood name
	//retrieve area size of neighborhood (measurement: area)
	//find number of neighboring neighborhoods (transformation: buffer; aggregation: count)
	
$(document).ready(function(){

	//initialize map
	var map = L.map('map', {
		center: [40.651978, -73.9385264],
		zoom: 11
	});
	
	//initialize and add basemap
	L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
    maxZoom: 18
	}).addTo(map);
	
	//var for neighborhood name, area
	var neighborhoodName;
	var neighborhoodArea;
	
	//create empty layer for TURF buffer
	turfLayerBuffer = L.geoJson(null, {
		style: {
			fillColor: 'orange',
			stroke: false
		}
	}).addTo(map);
	
		//create empty layer for TURF buffer
	turfLayerCenter = L.geoJson(null, {
		style: {
			fillColor: 'red',
			stroke: false
		}
	}).addTo(map);
	
	//create empty layer for TURF intersect
	turfLayerIntersect = L.geoJson(null, {
		style: {
			fillColor: 'orange',
			stroke: false
		}
	}).addTo(map);

	//retrieve Brooklyn neighborhoods geoJSon layer, add it to the map
	$.getJSON('http://catalog.opendata.city/dataset/7d28bbee-3e0b-45a3-8e8e-cbc8aebe6e5e/resource/77dc2ff5-0622-4076-95f9-54d8e77c3317/download/brooklynneighborhoodspolygon.geojson', function(data) {
		var neighborhoods = L.geoJson(data, {
			onEachFeature: function(feature, layer) {
				layer.on('click', function() {
					//clear the turf buffer layer
					turfLayerBuffer.clearLayers();
					//clear the turf centroid layer
					turfLayerCenter.clearLayers();
					//find neighborhood center
					neighborhoodCenter = turf.center(feature);
					turfLayerCenter.addData(neighborhoodCenter);
					
					//store neighborhood name
					neighborhoodName = layer.feature.properties.neighborhood;
					//calculate the area of the neighborhood, convert it to square miles, round to one decimal point, add " square miles" string
					neighborhoodArea = (turf.area(feature) * 0.000000386102159).toFixed(1) + " square miles";
					//calculate buffer around neighborhood, this returns a feature collection
					featureBuffer = turf.buffer(feature, 100, 'feet');
					console.log(featureBuffer);
					//uncomment after fixing other issues
					//add buffer layer to map
					turfLayerBuffer.addData(featureBuffer);
					
					//experimenting with this code...
					//erase the clicked feature from the buffer
					//featureErase = turf.erase(featureBuffer.features[0], feature);
					//find intersection of hollowed-out buffer area and overall geoJson
					//selectedNeighborhoods = turf.intersect(data, featureErase)
					
					//turfLayerIntersect.addData(selectedNeighborhoods);
					
					//uncomment after fixing other issues
					layer.bindPopup(neighborhoodName + " is <b>" + neighborhoodArea + "</b> in size.<br>The marker shows the geographic neighborhood center").openPopup();
					
				})
			}
		});
		
		neighborhoods.addTo(map);
	});
	
});

</script>

</body>

</html>
